<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, target-densitydpi=device-dpi">
  <meta name="renderer" content="webkit">
  <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  
  <title>FGO Servant</title>

  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2246f09bef1daa9c8bcc3ddec3239f8e";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
  
  
  <!-- <link rel="stylesheet" type="text/css" href="../static/css/layout.css"> -->
  <style type="text/css">
    /* Layout */
    html, body {
      overflow:hidden;
      overflow-y:auto;
      overflow-x:hidden;
    }

    body {
      margin: 0;
      padding: 0;
    }

    a, 
    a:hover,
    a:link,
    a:active,
    a:visited
     {
      text-decoration : none;
    } 

    .flex-container {
      display: flex;
      flex-flow: row wrap;
      justify-content: flex-start;

      margin: 50px;
    }
    /* Layout */

    html {
      max-width: 95vw;
    }

    .heads {
      width: 70%;
      margin: auto;
      margin-top: 30px;
    }
    .head img{
      width: 97px;
      height: 106px;
      margin: 10px 15px;
    }
    .word {
      width: 10vh;
    }
    .level-needs {
      list-style-type: none;
    }

    .thumb {
      width: 5.0vw;   /* 50px */
      height: 5.5vw;  /* 55px */
      margin-top: .5vw;
    }
    .thumb.servant {
      margin-top: 0;
    }
    .thumb.skill {
      width: 2.5vw;   /* 25px */
      height: 2.5vw;  /* 25px */
      position: relative;
      top: -2px;
    }

    .material-wrapper {
      display: inline-block;
      width: 8.5vw; /* 85px */
      font-weight: bold;
    }

    .total > .word {
      margin-right: 40px;
    }

    .materials, .level-need {
      width: 40vw;
      display: flex;
      flex-flow: row wrap;
      justify-content: flex-start;

    }

    .materials.calc-result {
      width: 50vw;
    }

    .nav-tabs.servant-classes {
      margin: 20px 0 0 0;
    }

    .summation {
      margin-top: 15px;
    }

    .tbl_servant{
      display: none;
    }


    input[type=number] {
      width: 5vw;
    }

    td span {
      position: relative;
      display: inline-block;
      top: 1px;
      left: 2px;
    }

    .glyphicon-play {
      margin-left: -5px;
    }

    .skill-input {
      display: inline-block; 
      transform: translateX(-10vw);
      margin-top: .5vw;
    }

    .level-input{
      display: inline-block; 
      margin-top: .5vw;
    }


    .skill-group {
      display: flex; 
      flex-flow: row wrap; 
      justify-content: space-between;
    }

    .skill-info, .skill-input, .level-input{
      display: inline-block;
    }

    .item.thumb + span {
      position: relative;
      top: 2vw;
    }
    
    .material-wrapper a + span {
      position: relative;
      top: 2vw;
    }


    @media screen and (max-width:  450px) {
      .flex-container{
        margin: 20px 10px;
      }

      .head img{
        width: 55px;
        height: 60px;
        margin: 4px 10px;
      }
      .heads {
        width: 90%;
      }
      .materials, .level-need {
        width: 320px;
      }
      .materials {
        margin-left: 12vw;
      }


    }

    @media screen and (max-width:  510px) {
      .flex-container{
        margin: 20px 10px;
      }
      input[type=number] {
        width: 25px;
      }
    }

    @media screen and (max-width:  1000px) {
      .thumb {
        width: 50px;   /* 50px */
        height: 55px;  /* 55px */
      }
      .thumb.skill {
        width: 25px;   /* 25px */
        height: 25px;  /* 25px */
      }

      .material-wrapper {
        display: inline-block;
        width: 85px; /* 85px */
        font-weight: bold;
      }

      .skill-input {
        margin-top: 3px;
      }

      .skill-input {
        transform: translateX(-.5vw);
      }

      .mobile-forbidden {
        display: none;
      }
    }

  </style>


</head>
<body>
  
  <ul class="nav nav-tabs">
    <li class="nav-tab item"><a href="../item.html">Items</a></li>
    <li class="nav-tab servant"><a href="../servant.html">Servants</a></li>
    <li class="nav-tab drop"><a href="../drop.html">Drops</a></li>
  </ul>

  <div id="content">
    
    <div class="head back">
      <a href="../servant.html">
        <img src="http://file.fgowiki.fgowiki.com/fgo/head/195.jpg">
      </a>
    </div>

      <div class="break flex-container">

        <h3 class="word">break: </h3>

        <ul class="level-needs">

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/48.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/powder.jpg">
                    </a>
                  <span>10</span>
                </span>

                <span class="material-wrapper">
                    <a href="../drop/45.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/paper.jpg">
                    </a>
                  <span>10</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/61.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/snake.jpg">
                    </a>
                  <span>10</span>
                </span>

                <span class="material-wrapper">
                    <a href="../drop/6.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/claw.jpg">
                    </a>
                  <span>10</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/16.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/fat.jpg">
                    </a>
                  <span>10</span>
                </span>

                <span class="material-wrapper">
                    <a href="../drop/77.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/tears.jpg">
                    </a>
                  <span>10</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/zhui.jpg">
                  <span>10</span>
                </span>

                <span class="material-wrapper">
                    <a href="../drop/11.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/danjieshi.jpg">
                    </a>
                  <span>10</span>
                </span>

            </li>

        </ul>

      </div>

      <div class="skill flex-container">

        <h3 class="word">skill: </h3>

        <ul class="level-needs">

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/79.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/walnut.jpg">
                    </a>
                  <span>10</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/5.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/chain.jpg">
                    </a>
                  <span>10</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/76.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/suiye.jpg">
                    </a>
                  <span>12</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/47.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/potion.jpg">
                    </a>
                  <span>12</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/17.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/feather.jpg">
                    </a>
                  <span>12</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/12.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/deng.jpg">
                    </a>
                  <span>15</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/50.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/root.jpg">
                    </a>
                  <span>15</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <a href="../drop/36.html">
                      <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/heart.jpg">
                    </a>
                  <span>15</span>
                </span>

            </li>

            <li class="level-need">


                <span class="material-wrapper">
                    <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/cubes.jpg">
                  <span>1</span>
                </span>

            </li>

        </ul>

      </div>

    <div class="total flex-container">
    <h3 class="word">total: </h3>
      
      <div class="materials">
        <span class="material-wrapper">
          <a href="../drop/5.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/chain.jpg">
          </a>
          <span>30</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/48.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/powder.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/76.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/suiye.jpg">
          </a>
          <span>36</span>
        </span>
        <span class="material-wrapper">
          <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/zhui.jpg">
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/17.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/feather.jpg">
          </a>
          <span>36</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/45.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/paper.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/47.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/potion.jpg">
          </a>
          <span>36</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/61.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/snake.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/79.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/walnut.jpg">
          </a>
          <span>30</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/6.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/claw.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/11.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/danjieshi.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/12.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/deng.jpg">
          </a>
          <span>45</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/16.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/fat.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/36.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/heart.jpg">
          </a>
          <span>45</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/50.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/root.jpg">
          </a>
          <span>45</span>
        </span>
        <span class="material-wrapper">
          <a href="../drop/77.html">
            <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/tears.jpg">
          </a>
          <span>10</span>
        </span>
        <span class="material-wrapper">
          <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/cubes.jpg">
          <span>3</span>
        </span>
      </div>

    </div>

    

  </div>

  
  <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/2.3.1/js/bootstrap-button.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/2.3.1/js/bootstrap-button.js"></script>
    
  

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){

      activate_tab()

      $('.servant-class.Saber').addClass('active')
      $('#Saber').addClass('active')

      
      let heads = $('.flex-item.head a');
      let nums = new Array();
      for (let i = 0; i < heads.length; i++) {
        let num = $(heads[i]).attr('data_num');
        nums[i] = num;
      }
      //console.log(nums)
      


      
      let tbl = $('.tbl_servant');
      let trs = $('.tbl_servant tr[data_num]')
      trs.css('display','none')

      let calc = $('.calc')

      let result = $('.total.calc-result')

      $('.summation').on('click', function(){
        heads.toggleClass('sum')
        calc.toggle()
        if ($(heads[0]).hasClass('sum')) {
          heads.attr('href', 'javascript:;')
          tbl.css('display', 'table')
          bind_summation()
          result.show()

        } else {
          for (let i = 0; i < heads.length; i++) {
            $(heads[i]).attr('href', `/servant/${nums[i]}/`)
          }
          tbl.css('display', 'none')
          //let trs = $('.tbl_servant tr[data_num]')
          //trs.css('display','none')
          heads.off('click')
          result.hide()
        }
      })




      

      calc.on('click', function () {

        let calc_trs = $(`tbody tr`)
        // get level gaps of servants
        let level_pairs = []
        for (let tr of calc_trs) {
          let num = $(tr).attr('data_num')
          let star = $(tr).find('input[data-star]').attr('data-star')
          let texts = $(tr).find(`td:eq(1) input[type='number']`)
          let broken = $(tr).find(`td:eq(1) input[type='checkbox']`).hasClass('checked')
          let level_pair = []
          for (let text of texts) {
            level_pair.push($(text).val())
          }
          let level_pair_b = {
            servant_id: num,
            star: star,
            broken: broken,
            level_pair: level_pair
          }
          level_pairs.push(level_pair_b)
        }
        //console.log(level_pairs)

        let skill_pairs = []
        for (let tr of calc_trs) {
          let num = $(tr).attr('data_num')
          let star = $(tr).find('input[data-star]').attr('data-star')
          let skill_inputs = $(tr).find('td:eq(2) .skill-input')
          let servant_level_pairs = []
          for (let skill_input of skill_inputs) {
            let texts = $(skill_input).find('input')
            let level_pair = []
            for (let text of texts) {
              val = $(text).val()
              level_pair.push(val)
            }
            servant_level_pairs.push(level_pair)
          }
          let servant = {
            servant_id: num,
            servant_skill_pairs: servant_level_pairs,
            star: star
          }
          skill_pairs.push(servant)
        }


        //localStorage.clear()


        //console.log(skill_pairs)
        //$.ajaxSettings.async = false;
        Promise
          .all([get_break_data(), get_together_need(), get_qp_cost(), get_exps_calc()])
          .then(function (result) {
            return data_handler(result)
          })


        function data_handler(result) {
          let [break_data, together_datas, qp_cost, exps_data] = result

          let level_breaks = break_data_handler(break_data)

          set_local_storage('qp_cost', qp_cost)
          set_local_storage('break_data', break_data)
          set_local_storage('exps_data', exps_data)
          set_local_storage('together_datas', together_datas)

          together_data_handler(together_datas, level_breaks)

          exps_handler(exps_data)

          qp_cost_handler(qp_cost, level_breaks)


        }

        function qp_cost_handler (qp_cost, level_breaks) {
          let all_break_need_qp = 0
          for (let level_break of level_breaks) {
            let {breaks, star} = level_break
            let [low, high] = breaks
            let break_need_qp_list = qp_cost['break'][star]
            let break_need_qp = calc_exps(break_need_qp_list, breaks, 1)
            //console.log(break_need_qp)
            all_break_need_qp += break_need_qp
          }
          //console.log(all_break_need_qp)

          let all_skill_need_qp = 0
          for (let skill_pair of skill_pairs) {
            let {servant_skill_pairs, star} = skill_pair
            let skill_need_qp_list = qp_cost['skill'][star]
            for (let servant_skill_pair of servant_skill_pairs) {
              let break_need_qp = calc_exps(skill_need_qp_list, servant_skill_pair, 1)
              all_skill_need_qp += break_need_qp
            }
          }
          //console.log(all_skill_need_qp)

          let all_need_qp = all_break_need_qp + all_skill_need_qp
          all_need_qp = toThousands(all_need_qp)

          let result_div = $('.materials.calc-result')
          let need_qp = $(`<span class="material-wrapper">
                              <img class="item thumb" src="../static/images/material/qp.jpg">
                              <span style="position:relative;left:5vw;top:-2vw;">${all_need_qp}</span>
                            </span>`)
          result_div.append(need_qp)
        }

        function break_data_handler (break_data) {
          let level_breaks = []
          for (let level_pair of level_pairs) {
            level_break = level_to_break(level_pair, break_data)
            level_breaks.push(level_break)
          }
          return level_breaks
        }

        function together_data_handler (together_datas, level_breaks) {
          let result_div = $('.materials.calc-result')
          result_div.empty()
          //console.log(together_datas)
          let {data, ordered_ids} = together_datas
          let servants_skill_need = []
          for (let skill_pair of skill_pairs) {
            let {servant_id, servant_skill_pairs} = skill_pair
            let [bs_level_needs, total_needs, total] = data[servant_id]
            let [word, skill_needs] = bs_level_needs[1]
            //console.log(servant_skill_pairs)
            let servant_skill_need = calc_skill_pairs_needs(skill_needs, servant_skill_pairs)
            servants_skill_need.push(servant_skill_need)
          }

          let all_skill_need = servants_skill_need.reduce(push_items_together)
          //console.log(all_skill_need)

          
          let servants_break_need = []
          //console.log(level_breaks)
          for (let level_break of level_breaks) {
            let {servant_id, breaks} = level_break
            //console.log(breaks)
            let [bs_level_needs, total_needs, total] = data[servant_id]
            let [word, break_needs] = bs_level_needs[0]
            let servant_break_need = calc_skill_needs(break_needs, breaks)
            servants_break_need.push(servant_break_need)
          }

          let all_break_need = servants_break_need.reduce(push_items_together)
          //console.log(all_break_need)

          let all_need = push_items_together(all_skill_need, all_break_need)
          //console.log(all_need)
          all_need.sort((x, y) => ordered_ids.indexOf(x[0]) - ordered_ids.indexOf(y[0]))
          
          for (let need of all_need) {
            let need_span = $(`<span class="material-wrapper">
                                <img class="item thumb" src="http://file.fgowiki.fgowiki.com/fgo/material/${need[1]}.jpg">
                                <span>${need[2]}</span>
                              </span>`)
            result_div.append(need_span)
          }
        }

        function exps_handler (data) {
          dog_foods = 0
          for (let servant_level_pair of level_pairs) {
            let {level_pair} = servant_level_pair
            let dog_food = calc_exps(data, level_pair)
            //console.log(calc_exps(data, level_pair))
            dog_foods += dog_food
          }
          let result_div = $('.materials.calc-result')
          let need_food = $(`<span class="material-wrapper">
                              <img class="item thumb" src="../static/images/material/dogfood.jpg">
                              <span>${dog_foods}</span>
                            </span>`)
          result_div.append(need_food)
          //console.log(dog_foods)
        }


        function get_qp_cost () {
          let url = '..../static/json/extra/qp_cost.json'
          let name = 'qp_cost'
          return get_local_storage(name, url)

        }

        function get_break_data () {
          let url = '..../static/json/extra/star_break_levels.json'
          let name = 'break_data'
          return get_local_storage(name, url)
        }

        function get_together_need () {
          let url = '..../static/json/servant_need/together_need.json'
          let name = 'together_datas'
          return get_local_storage(name, url)
        }

        function get_exps_calc() {
          let url = '..../static/json/extra/levelup_exps_calc.json'
          let name = 'exps_data'
          return get_local_storage(name, url)
        }

        //function


      })


    })

    let valid_len_data = {
      'together_datas': 239951
    }

    function get_local_storage(name, url) {
      let local = localStorage[name]
      if (local !== undefined) {
        if ( (name in valid_len_data && local.length === valid_len_data[name]) || !(name in valid_len_data) ){
          return JSON.parse(local)
        }    
      }
      return $.getJSON({
        url: url,
        global: false
      })

    }

    function set_local_storage(name, obj) {
      let local = localStorage[name]
      if (local === undefined || (name in valid_len_data && local.length !== valid_len_data[name])) {
        localStorage[name] = JSON.stringify(obj)
      }
    }

    function toThousands(num) {  
      var num = (num || 0).toString(), result = '';  
      while (num.length > 3) {  
          result = ',' + num.slice(-3) + result;  
          num = num.slice(0, num.length - 3);  
      }  
      if (num) { result = num + result; }  
      return result;  
    }  


    function ajax(param, callback){  
      $.ajax({  
          url:param,  
          type:'get',  
          success:function(data){  
              callback(data);   
          },  
          error:function(data){  
              console.log('error');  
          }         
      })  
    }  

    function request(url){  
      return new Promise(function(resolve,reject){  
          ajax(url,resolve);    
      });  
    }  

    function level_to_break(level_pair_obj, break_levels){
      let {servant_id, star, broken, level_pair} = level_pair_obj
      let break_level = break_levels[star]
      let [low, high] = level_pair
      low = Number(low)
      high = Number(high)

      let breaks = []
      for (let i = 0; i < break_level.length; i++) {
        if (break_level[i] < high && break_level[i] > low) {
          breaks.push(i)
        }
        if (!broken && break_level[i] == low) {
          breaks.push(i)
        }
      }

      if (breaks.length === 0) {
        breaks = [1, 1]
      } else {
        low = Math.min(...breaks)
        high = Math.max(...breaks)  
        breaks = [low+1, high+2]      
      }


      return {
        servant_id: servant_id,
        star: star,
        breaks: breaks,
        broken: broken
      }

    }

    function calc_exps(exps_levels, pair, exp_per_card=32400) {
      let [low, high] = pair
      low = Number(low)
      high = Number(high)
      let exps = 0
      for (let i = low-1; i < high-1; i++) {
        exps += exps_levels[i]
      }
      return Math.ceil(exps/exp_per_card)

    }

    function calc_skill_pairs_needs(skill_needs, skill_pairs) {
      let needs = []
      for (let pair of skill_pairs) {
        need = calc_skill_needs(skill_needs, pair)
        needs.push(need)
      }
      return needs.reduce(push_items_together)
    }

    function calc_skill_needs(skill_needs, skill_pair) {
      let [low, high] = skill_pair
      low = Number(low)
      high = Number(high)
      let result = []
      for (let i = low-1; i <= high-2; i++) {
        result = push_items_together(result ,skill_needs[i])
      }
      return result
    }
    // item: [id, name, num]
    function push_items_together(items_1, items_2) {
      if (items_1.length !== 0 && items_2.length === 0) {
        return push_items_together(items_2, items_1)
      } 
      let result = JSON.parse(JSON.stringify(items_2))
      outer:
      for (let j = 0; j < items_1.length; j++) {
        //console.log('j:' + j)
        for (let i = 0; i < result.length; i++) {
          //console.log('i:' + i)
          //console.log(result.length)
          if (items_1[j][0] === result[i][0]) {
            result[i][2] += items_1[j][2]
            continue outer;
          } else if (i === result.length - 1) {
            result.push(items_1[j])
            break;
          }
        }
      }

      return result
    }



    function activate_tab() {
      let cur_tab = $('.nav-tab.servant')
      cur_tab.addClass('active')
    }

    function bind_summation(){
      let heads = $('.flex-item.head a')
      let tbody = $('.tbl_servant tbody')
      let url = '..../static/json/about_ids_names/servant_ids_by_star.json'
      $.getJSON(url, function(data){
        for (let i = 0; i < heads.length; i++) {
          $(heads[i]).on('click', function(){
            let data_num = this.getAttribute('data_num')
            //console.log(data)

            let tr = $(`<tr data_num="${data_num}"></tr>`)

            let td_1 = $(`<td><img src="http://file.fgowiki.fgowiki.com/fgo/head/${data_num}.jpg" class="thumb servant"></td>`)

            let td_2 = $(`<td></td>`)

            let td_2_input_1 = $(`<input type="number" value="1" class="servant_lv from_lv" data-type="from_lv" min="1" max="90">`)

            let td_2_glyphicon = $(`<span class="glyphicon glyphicon-play" aria-hidden="true" style="margin: 0 2px 0 1px; left: 0"></span>`)

            let td_2_input_2 = $(`<input type="number" value="" class="servant_lv to_lv" data-type="to_lv" min="1" max="90" data-star=0><br>`)
            if (data[0].indexOf(data_num) !== -1) {
              td_2_input_2.val(65)
              td_2_input_2.attr('data-star', 0)
            } else if (data[1].indexOf(data_num) !== -1) {
              td_2_input_2.val(60)
              td_2_input_2.attr('data-star', 1)
            } else if (data[2].indexOf(data_num) !== -1) {
              td_2_input_2.val(65)
              td_2_input_2.attr('data-star', 2)
            } else if (data[3].indexOf(data_num) !== -1) {
              td_2_input_2.val(70)
              td_2_input_2.attr('data-star', 3)
            } else if (data[4].indexOf(data_num) !== -1) {
              td_2_input_2.val(80)
              td_2_input_2.attr('data-star', 4)
            } else if (data[5].indexOf(data_num) !== -1) {
              td_2_input_2.val(90)
              td_2_input_2.attr('data-star', 5)
            }

            let td_2_checkbox = $(`<label>broken
                <input type="checkbox" style="position: relative; top: 3px;">   
              </label>`)

            let td_2_div = $(`<div class="level-input"></div>`)
            td_2_div.append(td_2_input_1)
                    .append(td_2_glyphicon)
                    .append(td_2_input_2)
                    .append(td_2_checkbox)

            
            td_2.append(td_2_div)


            let td_3 = $(`<td></td>`)

            for (let i = 1; i <= 3; i++) {
              let td_3_skill_group = $(`<div class="skill-group"></div`)

              let td_3_skill_info = $(`<div class="skill-info">
                <img src="#" id="skill${i}" class="skill thumb">
                <span class="skill_name"></span>
              </div>`)

              let td_3_skill_input = $(`<div class="skill-input">
                <input type="number" value="1" class="skill_lv from_skill_lv" data-type="from_skill_lv_1" min="1" max="10">
                <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
                <input type="number" value="10" class="skill_lv to_skill_lv" data-type="to_skill_lv_1" min="1" max="10">
              </div>`)

              td_3_skill_group.append(td_3_skill_info)
                              .append(td_3_skill_input)

              td_3.append(td_3_skill_group)

            }

            let td_4 = $(`<td></td>`)

            let td_4_delete_btn = $(`<button type="button" class="btn btn-danger delete">Delete</button>`)

            td_4_delete_btn.on('click', function(){
              let tr = $(this).parent().parent()
              let data_num = tr.attr('data_num')
              tr.remove()
              let head = $(`.flex-item.head a[data_num='${data_num}']`);
              head.show()
            })

            td_4.append(td_4_delete_btn)


            tr.append(td_1)
              .append(td_2)
              .append(td_3)
              .append(td_4)

            tbody.append(tr)

            tr.find(`input[type='checkbox']`).on('change', function(){
              $(this).toggleClass('checked')
            })

            tr.find(`input[type='number']`).on('focus', function(){
              $(this).select()
            })

            let url = '..../static/json/extra/skill/skill_names_compl.json'
            $.getJSON(url, function(data){
                let id = Number(data_num) - 1
                let [skill_names, img_names] = data[id]

                imgs = $(`tr[data_num='${data_num}'] td:eq(2) img`)
                spans = $(`tr[data_num='${data_num}'] td:eq(2) span.skill_name`)
                for (let i = 0; i < imgs.length; i++) {
                  $(imgs[i]).attr('src', `http://file.fgowiki.fgowiki.com/mobile/images/Skill/${img_names[i]}.png`)
                  $(spans[i]).text(skill_names[i])
                }

            })


            //let tr = $(`tr[data_num='${data_num}']`)
            //tr.css('display', 'table-row')
            //tr.attr('data-calc', true)
            $(this).hide()
          })
        }
      })

    }

    function pad(num, n) {  
      let len = num.toString().length;  
      while(len < n) {  
          num = "0" + num;  
          len++;  
      }  
      return num;  
    }  

    function pad_char(num, n, char, direction) {  
      let len = num.toString().length * 4.3;  
      if (direction === 'left') {
        while(len < n) {  
          num = char + num;  
          len++;  
        }    
      } else {
        while(len < n) {  
          num = num + char;  
          len++;  
        }    
      }
      return num;  
    }  



  </script>


  

</body>
</html>
